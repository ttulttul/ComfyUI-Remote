# Learnings

- Implemented the first iteration of a "Remote API" node using the V3 schema, which exposes an autogrowing list of `ANY` inputs and a single `ANY` output.
- Established a JSON protocol that pickles inputs into base64 strings alongside their inferred Comfy types, enabling arbitrary payloads to be shipped to remote workers.
- Added a polling loop that understands `status`, `progress`, and `poll_url` fields to surface remote progress in the ComfyUI progress bar via the latest API helpers.
- Captured the new helper utilities in `comfy_remote.protocol` to keep serialization logic testable; see `tests/test_protocol.py` for coverage of edge cases.
- Introduced Remote Input/Output nodes that act as explicit ingress/egress points for remote payloads, complete with injection helpers for the Modal build pipeline.
- Added a Modal Deployment node that scaffolds a Modal Modal project using Modal's Python API, optionally shells out to `modal deploy`, and returns the service URL so the Remote API node can target the deployed workflow.
- Reworked the Modal scaffold to drop the external `modal-comfy-worker` dependency; we now generate `workflow.py` from an internal template and capture additional package requirements in `modal_config.json`, defaulting to a GPU-backed (`H100`) deployment unless overridden, force-reinstalling the CUDA PyTorch stack (`torch==2.3.0`, `torchvision==0.18.0`, `torchaudio==2.3.0`) plus `xformers`, and exporting `/workspace/ComfyUI` on `PYTHONPATH` so the bundled `utils` package resolves correctly.
- Modal GPU builds were downgrading `torchvision` after `xformers` installed its own dependencies, which surfaced remotely as `operator torchvision::nms does not exist`; the scaffold now pins the torch/torchvision/torchaudio stack after every dependency install and uses `pip install --no-deps` for the CUDA `xformers==0.0.26.post1` wheel so the detection ops stay registered inside the Modal container.
- Modal deployments now evict third-party `utils` packages (`pip uninstall -y utils`), force-load `/workspace/ComfyUI/utils` via a shim, and embed the workflow JSON inside `workflow.py`, ensuring `utils.install_util` is always available without mounting `prompt.json`.
- Added a `Clean Build` switch to the Modal Deployment node so we can remove stale project directories (and Modal CLI state) before regenerating the scaffold when a previous deployment needs to be blown away.
- Added a `Rebuild Modal App` option that injects a build nonce into the generated Modal project and runs `modal deploy` with `MODAL_IGNORE_CACHE=1`, plus a `Delete Modal App` toggle that shells out to `modal app stop <app>` so we can terminate the remote deployment before redeploying.
- Learned that the Modal runtime must mirror `execution.validate_prompt` to discover output nodes—without it the executor never stages any work and `Remote Output` nodes stay empty—so `Remote Output` is now flagged as an output node, the runtime validates prompts before execution, and the node logs every stored key/value to make diagnosing missing payloads easier.
